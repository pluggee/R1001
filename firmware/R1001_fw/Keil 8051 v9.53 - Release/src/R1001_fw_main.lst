C51 COMPILER V9.53.0.0   R1001_FW_MAIN                                                     10/23/2016 00:58:56 PAGE 1   


C51 COMPILER V9.53.0.0, COMPILATION OF MODULE R1001_FW_MAIN
OBJECT MODULE PLACED IN .\src/R1001_fw_main.OBJ
COMPILER INVOKED BY: Z:\Applications\SimplicityStudio_v3\developer\toolchains\keil_8051\9.53\BIN\C51.exe /Users/sherifei
                    -d/plugge_git/R1001/firmware/R1001_fw/src/R1001_fw_main.c OMF2 SMALL DEBUG OBJECTEXTEND ROM(LARGE) WARNINGLEVEL(2) FLOATF
                    -UZZY(3) OPTIMIZE(9,SPEED) DEFINE(NDEBUG=1) INTVECTOR(0X0000) INTPROMOTE INCDIR(/Users/sherifeid/plugge_git/R1001/firmwar
                    -e/R1001_fw/inc;/Applications/SimplicityStudio_v3/developer/sdks/si8051/v3//Device/shared/si8051Base;/Applications/Simpli
                    -cityStudio_v3/developer/sdks/si8051/v3//Device/EFM8BB1;/Applications/SimplicityStudio_v3/developer/sdks/si8051/v3//Devic
                    -e/EFM8BB1/inc) REGFILE(R1001_fw.ORC) PRINT(.\src/R1001_fw_main.lst) COND PAGEWIDTH(120) PAGELENGTH(65) OBJECT(.\src/R100
                    -1_fw_main.OBJ)

line level    source

   1          
   2          //-----------------------------------------------------------------------------
   3          // Includes
   4          //-----------------------------------------------------------------------------
   5          #include <SI_EFM8BB1_Register_Enums.h>                  // SFR declarations
   6          #include "InitDevice.h"
   7          #include "compiler_defs.h"
   8          #include "drv8825.h"
   9          #include "i2c.h"
  10          #include "global.h"
  11          
  12          // $[Generated Includes]
  13          // [Generated Includes]$
  14          
  15          //-----------------------------------------------------------------------------
  16          // Global Constants
  17          //-----------------------------------------------------------------------------
  18          //#define PLATFORM    0x01        // platform ID, 0x01 for R1000A
  19          #define PLATFORM    0xae        // platform ID, 0x01 for R1000A
  20          //#define DEVID       0x01        // device ID, 0x01 for R1001 stepper motor driver
  21          #define DEVID       0xc0        // device ID, 0x01 for R1001 stepper motor driver
  22          //#define FWVER       0x01        // firmware release
  23          #define FWVER       0xee        // firmware release
  24          //-----------------------------------------------------------------------------
  25          // Global Variables
  26          //-----------------------------------------------------------------------------
  27          
  28          
  29          // Global holder for SMBus data.
  30          // All receive data is written here
  31          // NUM_BYTES_WR used because an SMBus write is Master->Slave
  32          uint8_t SMB_DATA_IN[NUM_BYTES_WR];
  33          
  34          // Global holder for SMBus data.
  35          // All transmit data is read from here
  36          // NUM_BYTES_RD used because an SMBus read is Slave->Master
  37          uint8_t SMB_DATA_OUT[NUM_BYTES_RD];
  38          
  39          bit DATA_READY = 0;                    // Set to '1' by the SMBus ISR
  40                                                 // when a new data byte has been
  41                                                 // received.
  42          
  43          // Driver Initialization function
  44          void Init (void)
  45          {
  46   1              drv8825_init();                     // Initialize driver
  47   1              SetI2CSlaveAddress();               // Initialize I2C slave address
  48   1      }
  49          
  50          //-----------------------------------------------------------------------------
C51 COMPILER V9.53.0.0   R1001_FW_MAIN                                                     10/23/2016 00:58:56 PAGE 2   

  51          // main() Routine
  52          // ----------------------------------------------------------------------------
  53          int main (void)
  54          {
  55   1              // Call hardware initialization routine
  56   1              enter_DefaultMode_from_RESET();
  57   1      
  58   1              Init();                                         // Initialize system
  59   1      
  60   1              while (1) 
  61   1         {
  62   2                      while (!DATA_READY);             // New SMBus data received? gets out of the loop with a command transfe
             -r is complete
  63   2                      DATA_READY = 0;
  64   2      
  65   2                      // now we look at the contents of the data in the buffer and act accordingly
  66   2                      switch(SMB_DATA_IN[0]){
  67   3                      case 0x01:
  68   3                              // Return the module ID
  69   3                              // Prepare buffer with ID string
  70   3                              SMB_DATA_OUT[0] = PLATFORM;     // Platform ID
  71   3                              break;
  72   3                      case 0x02:
  73   3                              // Return the module ID
  74   3                              // Prepare buffer with ID string
  75   3                              SMB_DATA_OUT[0] = DEVID;        // device ID
  76   3                              break;
  77   3                      case 0x03:
  78   3                              // Return the module ID
  79   3                              // Prepare buffer with ID string
  80   3                              SMB_DATA_OUT[0] = FWVER;        // firmware version
  81   3                              break;
  82   3                      case 0x10:
  83   3                  // This reads out the temperature value
  84   3                  SMB_DATA_OUT[0] = temp_val;
  85   3                  break;
  86   3                      case 0x20:
  87   3                              // Set stepper motor stepping resolution
  88   3                              // This is a command to change stepping resolution, set it to the value stored in SMB_DATA_IN[1]
  89   3                          if (writelen > 1){
  90   4                                  StepRes = SMB_DATA_IN[1];       // store new value to internal variable
  91   4                                  SetSteppingMode();              // apply new stepping resolution setting
  92   4                              }
  93   3                          SMB_DATA_OUT[0] = StepRes;
  94   3                              break;
  95   3                      case 0x21:
  96   3                          // here we check if writing to IDRVL and IDRVH
  97   3                          if (writelen == 2){
  98   4                      // only write IDRVL
  99   4                              IDRVL = SMB_DATA_IN[1];         // store new value to internal variable
 100   4                              SetDriveCurrent();              // apply new stepping driver current
 101   4                  }
 102   3                          else if (writelen > 2){
 103   4                      // write IDRVL & IDRVH
 104   4                      IDRVL = SMB_DATA_IN[1];         // store new value to internal variable
 105   4                      IDRVH = SMB_DATA_IN[2];         // store new value to internal variable
 106   4                      SetDriveCurrent();              // apply new stepping driver current
 107   4                  }
 108   3      
 109   3                          // Store IDRVL/H values into output buffer
 110   3                          SMB_DATA_OUT[0] = IDRVL;
 111   3                              SMB_DATA_OUT[1] = IDRVH;
 112   3                              break;
C51 COMPILER V9.53.0.0   R1001_FW_MAIN                                                     10/23/2016 00:58:56 PAGE 3   

 113   3                      case 0x22:
 114   3                  // here we check if writing to IDRVH
 115   3                  if (writelen > 1){
 116   4                      // only write IDRVH
 117   4                      IDRVH = SMB_DATA_IN[1];         // store new value to internal variable
 118   4                      SetDriveCurrent();              // apply new stepping driver current
 119   4                  }
 120   3                  // Store IDRVH value in output buffer
 121   3                  SMB_DATA_OUT[0] = IDRVH;
 122   3                              break;
 123   3                      case 0x23:
 124   3                          // Stepper driver control register
 125   3                          if (writelen > 1){
 126   4                      // parse input and execute values
 127   4                      MCTL = SMB_DATA_IN[1];          // store new value to internal variable
 128   4                      RefreshMCTL();                  // apply new stepping driver current
 129   4                  }
 130   3                          SMB_DATA_OUT[0] = MCTL;             // place refreshed MCTL value in output buffer
 131   3                          break;
 132   3                      case 0x24:
 133   3                          // refresh status register before pushing it out
 134   3                          RefreshMSTAT();
 135   3                  SMB_DATA_OUT[0] = MSTAT;             // place refreshed MCTL value in output buffer
 136   3                  break;
 137   3                      case 0x25:
 138   3                          // FIXME, experimental, remove this
 139   3                          SMB_DATA_OUT[0] = PCA0CPH0;
 140   3                          break;
 141   3                      default:
 142   3                              break;
 143   3                      }
 144   2         }                             
 145   1      }


MODULE INFORMATION:   STATIC OVERLAYABLE
   CODE SIZE        =    185    ----
   CONSTANT SIZE    =   ----    ----
   XDATA SIZE       =   ----    ----
   PDATA SIZE       =   ----    ----
   DATA SIZE        =      6    ----
   IDATA SIZE       =   ----    ----
   BIT SIZE         =      1    ----
   EDATA SIZE       =   ----    ----
   HDATA SIZE       =   ----    ----
   XDATA CONST SIZE =   ----    ----
   FAR CONST SIZE   =   ----    ----
END OF MODULE INFORMATION.


C51 COMPILATION COMPLETE.  0 WARNING(S),  0 ERROR(S)
